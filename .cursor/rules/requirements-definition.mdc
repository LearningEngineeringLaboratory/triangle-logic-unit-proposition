---
alwaysApply: true
---
# 単位命題三角ロジック演習システム 要件定義 v0.3

作成日：2025-10-05（JST）／更新：認証・セッション管理の詳細化

---

## 1. 背景・目的

単位命題三角ロジックを用いた学習演習システムを研究目的で開発し，学習過程の詳細ログを収集・分析できる基盤を構築する．

## 2. 技術スタック

* **フロントエンド**: Next.js App Router, TypeScript, TailwindCSS, shadcn/ui, Radix UI
* **バックエンド**: Next.js Server Actions, Route Handlers
* **データベース**: Supabase (PostgreSQL + RLS)
* **デプロイ**: Vercel

## 3. 主要機能

### 3.1 学習フロー
1. **ユーザー登録**: 初回アクセスで名前・メールアドレスを入力し`user_id`（ULID）を発行
2. **セッション管理**: `session_id`（ULID）を発行しHttpOnly Cookieに保存
3. **ステップ型演習**: 問題一覧→問題詳細→**ステップ型UI（必ず順番に進行）**
4. **答え合わせ機能**: 各ステップで即座に正誤判定を実行
5. **クリア条件**: **各ステップで正解しないと次のステップに進めない**
6. **状態保存**: 問題ごとの最新状態を随時更新し，Cookieで復帰

### 3.2 ログ収集
* **即時ログ送信**: 選択系操作はすべて即座にAPI送信
* **イベント記録**: 操作内容、正誤判定、所要時間を詳細記録

## 4. 認証・セッション管理

### 4.1 認証フロー

#### 初回アクセス時
1. **セッション確認**: HttpOnly Cookieから`session_id`を取得
2. **セッション有効性チェック**: セッションが存在し、有効期限内かチェック
3. **セッション復帰**: 有効なセッションがあれば、既存の学習状態で復帰

#### セッションがない場合
1. **ユーザー登録フォーム表示**: 名前・メールアドレス入力フォームを表示
2. **既存ユーザー検索**: 入力されたメールアドレスで既存ユーザーを検索
3. **処理分岐**:
   - **既存ユーザー**: 新しいセッションを作成し、過去の学習進捗を引き継ぎ
   - **新規ユーザー**: ユーザー登録 → 新セッション作成

#### 再アクセス時（同じメールアドレス）
1. **セッション復帰を優先**: 有効なセッションがあれば復帰
2. **既存ユーザー検索**: セッションがない場合はメールアドレスで既存ユーザーを検索
3. **新セッション作成**: 既存ユーザーの場合は新しいセッションを作成
4. **学習進捗引き継ぎ**: 過去の`responses`テーブルのデータを復元

### 4.2 セッション管理仕様

#### セッション作成
```typescript
interface SessionData {
  session_id: string;        // ULID形式
  user_id: string;          // 既存ユーザーのID
  created_at: Date;         // セッション開始日時
  last_activity: Date;      // 最終活動日時
}
```

#### セッション有効性
- **有効期限**: 24時間（設定可能）
- **活動更新**: ユーザー操作のたびに`last_activity`を更新
- **自動延長**: 活動がある限りセッションを延長

#### セッション復帰処理
```typescript
// 1. CookieからセッションIDを取得
const sessionId = getCookie('session_id');

// 2. セッションの有効性をチェック
const session = await supabase
  .from('sessions')
  .select(`
    session_id,
    user_id,
    created_at,
    last_activity,
    users!inner(name, email)
  `)
  .eq('session_id', sessionId)
  .gte('last_activity', new Date(Date.now() - 24 * 60 * 60 * 1000)) // 24時間以内
  .single();

// 3. 有効なセッションがあれば復帰
if (session.data) {
  return {
    user: session.data.users,
    session: session.data,
    isReturningUser: true
  };
}
```

### 4.3 学習進捗の引き継ぎ

#### 既存ユーザーの場合
1. **最新の回答状態を取得**: `responses`テーブルから最新の`state`を取得
2. **進行中試行の復元**: `attempts`テーブルから`status='in_progress'`の試行を取得
3. **ステップ進捗の復元**: `current_step`と`passed_steps`を復元
4. **UI状態の復元**: 三角ロジックの選択状態を復元

#### データ取得クエリ例
```sql
-- 最新の回答状態を取得
SELECT state, current_step, passed_steps
FROM responses 
WHERE user_id = $1 
ORDER BY updated_at DESC 
LIMIT 1;

-- 進行中の試行を取得
SELECT attempt_id, problem_id, started_at
FROM attempts 
WHERE user_id = $1 AND status = 'in_progress'
ORDER BY started_at DESC;
```

## 5. データモデル

### 5.1 テーブル構成
* `users`: ユーザー情報（`user_id`, `name`, `email`, `created_at`）
* `problems`: 問題データ（`problem_id`, `total_steps`, `version`）
* `steps`: ステップデータ（`step_id`, `problem_id`, `step_number`, `argument`, `rubric`, `options`, `version`）
* `sessions`: セッション管理（`session_id`, `user_id`, `created_at`, `last_activity`）
* `attempts`: 試行記録（`session_id`, `user_id`, `problem_id`, `started_at`, `finished_at`, `status`）
* `events`: 操作ログ（`session_id`, `user_id`, `attempt_id`, `seq`, `kind`, `payload`, `client_ts`, `server_ts`）
* `problem_responses`: 問題回答状態（`problem_response_id`, `session_id`, `user_id`, `problem_id`, `current_step`, `passed_steps`, `is_completed`）
* `step_responses`: ステップ回答状態（`step_response_id`, `session_id`, `user_id`, `problem_id`, `step_number`, `step_id`, `state`, `is_passed`）

### 5.2 データ構造詳細
* `problems.total_steps`: 問題内のステップ数（可変対応）
* `steps.step_number`: ステップ番号（1, 2, 3...）
* `steps.options`: ドロップダウン選択肢の配列（例：["Pである", "Qである", "Rである"]）
* `steps.rubric`: そのステップの正解条件（JSON形式）
* `problem_responses.current_step`: 現在のステップ番号
* `problem_responses.passed_steps`: 合格したステップ番号の配列
* `step_responses.state`: ステップの回答状態（選択された値、リンクの向き等）

### 5.3 ID命名規則
* **問題ID**: `TLU-<set>-v<semver>` 例）`TLU-A-v1.0.0`
* **ステップID**: `TLU-<set>-Q<nn>-Step<step>-v<semver>` 例）`TLU-A-Q01-Step1-v1.0.0`

## 6. ステップ進行とクリア条件

### 6.1 問題・ステップ構成

#### 問題1（例）
**問題文**: PであるならばQである。また，QであるならばRである。したがって，PであるならばRである。

* **Step1**: 導出命題を構成（前件/後件ドロップダウン選択）
  - クリア条件: 正しい前件・後件の組み合わせを選択
* **Step2**: 所与命題を構成（ドロップダウン選択＋矢印向き反転）
  - クリア条件: 正しい所与命題の組み合わせと矢印方向を設定
* **Step3**: 推論形式と妥当性を選択
  - クリア条件: 正しい推論形式（演繹/仮説/非形式）と妥当性（妥当/非妥当）を選択

#### 問題2以降
- 同様の構造で複数の問題を配置
- 各問題は独立したステップ構成を持つ
- ステップ数は問題ごとに可変（現在は3ステップ、将来は4ステップ以上も可能）

### 6.2 進捗管理の階層構造

#### 問題レベル（problem_responses）
* **現在のステップ**: `current_step`で現在のステップ番号を管理
* **合格ステップ**: `passed_steps[]`で合格したステップ番号の配列を管理
* **問題完了**: `is_completed`で問題全体の完了状態を管理

#### ステップレベル（step_responses）
* **ステップ状態**: `state`で各ステップの詳細な回答状態を管理
* **ステップ合格**: `is_passed`でそのステップの合格状態を管理
* **ステップ参照**: `step_id`で対応するステップデータを参照

### 6.3 サーバ側検証
* **ステップゲーティング**: サーバ側で不正スキップ防止チェックを実施
* **階層的状態管理**: 問題レベルとステップレベルで分離して状態を管理
* **飛び級防止**: 前のステップが合格していない場合は次ステップへの進行を拒否
* **問題進行**: 全ステップが合格した場合のみ次の問題に進行可能

## 7. イベント記録

### 7.1 主要イベント
* `user_registered`: ユーザー登録（`name`, `email`）
* `session_created`: セッション作成（`user_id`, `session_id`）
* `session_restored`: セッション復帰（`user_id`, `session_id`）
* `select_dropdown`: ドロップダウン選択（`control_id`, `value`）
* `toggle_link_direction`: 矢印反転（`link_id`, `new_direction`）
* `step_completed`: ステップ完了（`step`, `result`, `is_correct`）
* `attempt_started`: 試行開始（`problem_id`）
* `attempt_finished`: 試行終了（`problem_id`, `success`）
* `check_answer`: 答え合わせボタンクリック
* `step_navigation`: ステップ切り替え（`from_step`, `to_step`）

### 7.2 ログ送信方式
* **即時送信**: 選択操作のたびに即座にAPI送信
* **バッチ送信**: ネットワーク不安定時のバッファリング機能
* **冪等性**: `idempotency_key`と`(session_id, seq)`で重複防止

## 8. API設計

### 8.1 エンドポイント
* `POST /api/register`: ユーザー登録
* `POST /api/session/create`: セッション作成
* `POST /api/session/restore`: セッション復帰
* `POST /api/log`: イベントログ送信
* `POST /api/submit`: 最終回答提出
* `POST /api/check-step`: ステップ正誤判定

### 8.2 セキュリティ
* **RLS**: 常時有効、`user_id`と`session_id`一致の行のみ参照可能
* **CSRF**: POST時にOrigin/Referer検証＋CSRFトークン
* **レート制限**: per-session 60 events/min, per-IP 300 events/min
* **メール重複チェック**: 同一メールアドレスの重複登録を防止

## 9. UI設計

### 9.1 レイアウト構成

#### PC画面（左右分割）
* **左側パネル**:
  - 最上部: 問題進捗インジケーター（[1]-[2]-[3]-[4]-[5]...形式）
  - 上部: 論証文表示
  - 下部: ステップ問題文（カルーセル形式で切り替え）
* **右側パネル**:
  - 単位命題三角ロジック表示エリア
  - 下部: 答え合わせボタン

#### モバイル画面（上下分割）
* 最上部: 論証文表示
* 上部: ステップ問題文（カルーセル形式で切り替え）
* 下部: 単位命題三角ロジック表示エリア
* 最下部: 答え合わせボタン

### 9.2 単位命題三角ロジック仕様

#### 基本構造
* **形状**: 逆正三角形
* **ノード**: 単位命題を表示（ドロップダウンで選択可能）
* **リンク**: 有向リンクでノード間を接続
* **選択肢**: 全ノードで同一の選択肢を使用

#### ステップ別表示
* **Step1**: 2ノード構成（左上・右上頂点）
  - 導出命題の前件・後件を選択
  - 例：「Pである→Rである」
* **Step2**: 3ノード構成（Step1 + 中央下頂点）
  - 所与命題の単位命題を選択
  - リンクの向き反転ボタン付き
  - 例：「Pである→Qである」「Qである→Rである」
* **Step3**: 表示のみ（操作不可）
  - 推論形式・妥当性選択UI

### 9.3 インタラクション仕様

#### 答え合わせ
* **タイミング**: 答え合わせボタン押下時
* **判定**: 全ステップで正解しないと次ステップに進行不可
* **フィードバック**: 正誤結果を即座に表示

#### 進捗管理
* **問題進捗**: 完了した問題番号まで色付き表示（[1]-[2]-[3]-[4]-[5]...形式）
* **ステップ進捗**: カルーセル形式で問題文切り替え
* **階層的状態保存**: 問題レベルとステップレベルで分離してCookieで進捗を保持
* **復帰時の整合性**: セッション復帰時に問題・ステップ両方の状態を復元

## 10. 非機能要件

* **パフォーマンス**: 通常操作でP95応答< 300ms
* **可用性**: 学習時間帯の無停止運用
* **アクセシビリティ**: WCAG 2.1 AA相当
* **ブラウザ対応**: 最新のChromium/Firefox/Safari（モバイル含む）

## 11. 実装上の注意点

### 11.1 セッション管理
- **セッション有効期限**: 24時間（設定可能）
- **自動延長**: ユーザー活動がある限りセッションを延長
- **セッション復帰**: 有効なセッションがあれば即座に復帰

### 11.2 学習進捗の保持
- **階層的状態管理**: 問題レベル（problem_responses）とステップレベル（step_responses）で分離管理
- **状態の永続化**: すべての操作を即座にデータベースに保存
- **復帰時の整合性**: セッション復帰時に問題・ステップ両方の最新状態を確実に復元
- **データの整合性**: 外部キー制約とRLSでデータの整合性を保証
- **可変ステップ対応**: 問題ごとに異なるステップ数に対応可能な設計

### 11.3 エラーハンドリング
- **ネットワークエラー**: オフライン時の操作をバッファリング
- **セッション切れ**: 自動的に再認証フローに遷移
- **データ不整合**: サーバー側で整合性チェックを実施