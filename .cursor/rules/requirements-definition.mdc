---
alwaysApply: true
---
# 単位命題三角ロジック演習システム 要件定義 v0.2

作成日：2025-10-04（JST）／更新：答え合わせ機能とクリア条件を明確化

---

## 1. 背景・目的

単位命題三角ロジックを用いた学習演習システムを研究目的で開発し，学習過程の詳細ログを収集・分析できる基盤を構築する．

## 2. 技術スタック

* **フロントエンド**: Next.js App Router, TypeScript, TailwindCSS, shadcn/ui, Radix UI
* **バックエンド**: Next.js Server Actions, Route Handlers
* **データベース**: Supabase (PostgreSQL + RLS)
* **デプロイ**: Vercel

## 3. 主要機能

### 3.1 学習フロー
1. **ユーザー登録**: 初回アクセスで名前・メールアドレスを入力し`user_id`（ULID）を発行
2. **セッション管理**: `session_id`（ULID）を発行しHttpOnly Cookieに保存
3. **ステップ型演習**: 問題一覧→問題詳細→**ステップ型UI（必ず順番に進行）**
4. **答え合わせ機能**: 各ステップで即座に正誤判定を実行
5. **クリア条件**: **各ステップで正解しないと次のステップに進めない**
6. **状態保存**: 問題ごとの最新状態を随時更新し，Cookieで復帰

### 3.2 ログ収集
* **即時ログ送信**: 選択系操作はすべて即座にAPI送信
* **イベント記録**: 操作内容、正誤判定、所要時間を詳細記録

## 4. データモデル

### 4.1 テーブル構成
* `users`: ユーザー情報（`user_id`, `name`, `email`, `created_at`）
* `problems`: 問題データ（`problem_id`, `title`, `body`, `rubric`, `options`, `version`）
* `sessions`: セッション管理（`session_id`, `user_id`, `created_at`）
* `attempts`: 試行記録（`session_id`, `user_id`, `problem_id`, `started_at`, `finished_at`, `status`）
* `events`: 操作ログ（`session_id`, `user_id`, `attempt_id`, `seq`, `kind`, `payload`, `client_ts`, `server_ts`）
* `responses`: 回答状態（`session_id`, `user_id`, `attempt_id`, `state`, `current_step`, `passed_steps`）
* `submissions`: 最終提出（`session_id`, `user_id`, `attempt_id`, `answer`, `score`, `submitted_at`）

### 4.2 データ構造詳細
* `problems.options`: ドロップダウン選択肢の配列（例：["Pである", "Qである", "Rである", "Sである"]）
* `problems.rubric`: 各ステップの正解条件（JSON形式）
* `responses.state`: 現在の回答状態（選択された値、リンクの向き等）

### 4.3 問題ID命名規則
形式：`TLU-<set>-Q<nn>-v<semver>` 例）`TLU-A-Q01-v1.0.0`

## 5. ステップ進行とクリア条件

### 5.1 ステップ構成（初期問題）
**問題文**: PであるならばQである。また，QであるならばRである。したがって，PであるならばRである。

* **Step1**: 導出命題を構成（前件/後件ドロップダウン選択）
  - クリア条件: 正しい前件・後件の組み合わせを選択
* **Step2**: 所与命題を構成（ドロップダウン選択＋矢印向き反転）
  - クリア条件: 正しい所与命題の組み合わせと矢印方向を設定
* **Step3**: 推論形式と妥当性を選択
  - クリア条件: 正しい推論形式（演繹/仮説/非形式）と妥当性（妥当/非妥当）を選択

### 5.2 サーバ側検証
* **ステップゲーティング**: サーバ側で不正スキップ防止チェックを実施
* **状態管理**: `responses.state`に`current_step`と`passed_steps[]`を保持
* **飛び級防止**: 前のステップが合格していない場合は次ステップへの進行を拒否

## 6. イベント記録

### 6.1 主要イベント
* `user_registered`: ユーザー登録（`name`, `email`）
* `select_dropdown`: ドロップダウン選択（`control_id`, `value`）
* `toggle_link_direction`: 矢印反転（`link_id`, `new_direction`）
* `step_completed`: ステップ完了（`step`, `result`, `is_correct`）
* `attempt_started`: 試行開始（`problem_id`）
* `attempt_finished`: 試行終了（`problem_id`, `success`）
* `check_answer`: 答え合わせボタンクリック
* `step_navigation`: ステップ切り替え（`from_step`, `to_step`）

### 6.2 ログ送信方式
* **即時送信**: 選択操作のたびに即座にAPI送信
* **バッチ送信**: ネットワーク不安定時のバッファリング機能
* **冪等性**: `idempotency_key`と`(session_id, seq)`で重複防止

## 7. API設計

### 7.1 エンドポイント
* `POST /api/register`: ユーザー登録
* `POST /api/log`: イベントログ送信
* `POST /api/submit`: 最終回答提出
* `POST /api/check-step`: ステップ正誤判定

### 7.2 セキュリティ
* **RLS**: 常時有効、`user_id`と`session_id`一致の行のみ参照可能
* **CSRF**: POST時にOrigin/Referer検証＋CSRFトークン
* **レート制限**: per-session 60 events/min, per-IP 300 events/min
* **メール重複チェック**: 同一メールアドレスの重複登録を防止

## 8. UI設計

### 8.1 レイアウト構成

#### PC画面（左右分割）
* **左側パネル**:
  - 最上部: 大問進捗インジケーター（[1]-[2]-[3]-[4]-[5]...形式）
  - 上部: 論証文表示
  - 下部: ステップ問題文（カルーセル形式で切り替え）
* **右側パネル**:
  - 単位命題三角ロジック表示エリア
  - 下部: 答え合わせボタン

#### モバイル画面（上下分割）
* 最上部: 論証文表示
* 上部: ステップ問題文（カルーセル形式で切り替え）
* 下部: 単位命題三角ロジック表示エリア
* 最下部: 答え合わせボタン

### 8.2 単位命題三角ロジック仕様

#### 基本構造
* **形状**: 逆正三角形
* **ノード**: 単位命題を表示（ドロップダウンで選択可能）
* **リンク**: 有向リンクでノード間を接続
* **選択肢**: 全ノードで同一の選択肢を使用

#### ステップ別表示
* **Step1**: 2ノード構成（左上・右上頂点）
  - 導出命題の前件・後件を選択
  - 例：「Pである→Rである」
* **Step2**: 3ノード構成（Step1 + 中央下頂点）
  - 所与命題の単位命題を選択
  - リンクの向き反転ボタン付き
  - 例：「Pである→Qである」「Qである→Rである」
* **Step3**: 表示のみ（操作不可）
  - 推論形式・妥当性選択UI

### 8.3 インタラクション仕様

#### 答え合わせ
* **タイミング**: 答え合わせボタン押下時
* **判定**: 全ステップで正解しないと次ステップに進行不可
* **フィードバック**: 正誤結果を即座に表示

#### 進捗管理
* **大問進捗**: 完了した大問番号まで色付き表示
* **ステップ進捗**: カルーセル形式で問題文切り替え
* **状態保存**: Cookieで進捗を保持

## 9. 非機能要件

* **パフォーマンス**: 通常操作でP95応答< 300ms
* **可用性**: 学習時間帯の無停止運用
* **アクセシビリティ**: WCAG 2.1 AA相当
* **ブラウザ対応**: 最新のChromium/Firefox/Safari（モバイル含む）